<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AB Nutri ‚Äî Starter</title>

<!-- √çcones iOS (Apple Touch) -->
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png?v=2">
<link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167x167.png?v=2">
<link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152x152.png?v=2">
<link rel="apple-touch-icon" sizes="120x120" href="apple-touch-icon-120x120.png?v=2">

<!-- Favicon padr√£o -->
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png?v=2">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png?v=2">
<link rel="icon" href="favicon.ico?v=2">

<style>
:root{
  --bg:#0d0f12;--card:#14171a;--line:#23272d;--text:#e8ecf2;--muted:#9aa0a6;--accent:#f59e0b;--accent2:#f8b844;
}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,"Noto Sans",sans-serif;background:var(--bg);color:var(--text)}
.header{height:88px;display:flex;align-items:center;gap:20px;padding:12px 24px;border-bottom:1px solid #111}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:84px;height:84px;border-radius:8px;background:linear-gradient(135deg,#222,#111);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px;color:var(--accent)}
.title{font-size:28px;color:var(--accent);font-weight:800}
.topnav{margin-left:auto;display:flex;gap:10px;align-items:center}
.chip {
  background:#0b0d0f;
  border:1px solid #222;
  padding:8px 14px;
  border-radius:999px;
  cursor:pointer;
  font-weight:800;
  color:#fff; /* texto branco quando n√£o selecionado */
}

.chip.active {
  background:linear-gradient(180deg,var(--accent2),var(--accent));
  color:#111; /* texto preto quando selecionado */
}
.container{max-width:1100px;margin:22px auto;padding:18px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);border:1px solid var(--line);border-radius:14px;padding:18px}
.center-screen{height:92vh;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px}
.login-card{width:420px;padding:28px;border-radius:14px}
.input{width:100%;padding:12px;border-radius:10px;border:1px solid #20252a;background:#0b0d0f;color:var(--text);margin:6px 0}
.btn{padding:12px 18px;border-radius:12px;border:none;background:var(--accent);color:#111;font-weight:800;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid #2a2f35;color:var(--text)}
.grid{display:grid;gap:12px}
.grid-3{grid-template-columns:1fr 1fr 1fr}
.grid-4{grid-template-columns:1fr 1fr 1fr 1fr
  align-items: start;}
.section-title{color:#ffd089;font-weight:800;margin-bottom:8px}
.small{font-size:13px;color:var(--muted)}
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table th,.table td{padding:12px;border-bottom:1px solid #222;text-align:left}
.right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
.meal-buttons{display:flex;gap:8px;margin-bottom:10px}
.badge{background:#0c0f12;border:1px solid #20252a;padding:10px 14px;border-radius:12px;font-weight:900;min-width:120px;text-align:center}
.fab{position:fixed;right:18px;bottom:18px;background:var(--accent);color:#111;border-radius:14px;padding:12px 18px;font-weight:900;cursor:pointer}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50}
.modal.open{display:flex}
.modal-card{width:min(760px,95vw);padding:18px;border-radius:12px;background:var(--card);border:1px solid var(--line)}
.flex{display:flex;gap:12px;align-items:center}
.space{flex:1}
.small-muted{color:var(--muted);font-size:13px}
.footer-note{font-size:12px;color:var(--muted);margin-top:8px}
.table-scroll{max-height:420px;overflow:auto}
.table-scroll{max-height:420px;overflow:auto}

/* === Ajustes responsivos para celular/tablet === */
@media (max-width: 480px) {
  /* Cards ocupam largura cheia */
  .card {
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 12px;
  }
  /* Reorganizar header no mobile */
  .header {
    flex-direction: column;
    align-items: stretch;
    height: auto;
  }

  .brand {
    justify-content: space-between;
    width: 100%;
  }

  #logoutBtn {
    margin-left: auto;
  }

  .topnav {
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 8px;
  }

  /* Barras (Meta di√°ria, Consumido, Restante) em coluna */
  .right {
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }
  .badge {
    min-width: 100%;
    text-align: center;
    padding: 12px;
    font-size: 14px;
  }

  /* Bot√µes de refei√ß√µes em 2 colunas */
  .meal-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .meal-buttons .chip {
    width: 100%;
    text-align: center;
  }

  /* Inputs e bot√µes de a√ß√£o em coluna */
  .flex {
    flex-direction: column;
    align-items: stretch;
  }
  #foodSelect, #foodQty {
    width: 100% !important;
  }

  /* Bot√µes principais maiores */
  .btn, .chip {
    font-size: 16px;
    padding: 14px;
    border-radius: 10px;
  }

  /* Resumo do dia em 2 colunas */
  #page-registro .flex {
    flex-wrap: wrap;
  }
  #page-registro .badge {
    flex: 1 1 45%;
  }

  /* Tabelas com scroll */
  .table-scroll {
    overflow-x: auto;
  }
  .table th, .table td {
    font-size: 12px;
    padding: 6px;
  }
}
</style>

<script type="module">
  import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@latest/+esm";
  window.BrowserMultiFormatReader = BrowserMultiFormatReader;

/* === Barcode Scanner + Open Food Facts === */
const scanBtn = document.getElementById('scanBarcodeBtn');
const preview = document.getElementById('previewScanner');

let codeReader = null;

scanBtn?.addEventListener('click', async () => {
  if (!codeReader) codeReader = new window.BrowserMultiFormatReader();
  preview.style.display = 'block';

  try {
    const result = await codeReader.decodeOnceFromVideoDevice(undefined, preview);
    const barcode = result.text;
    alert("C√≥digo lido: " + barcode);

    // Buscar produto na Open Food Facts
    const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
    const data = await res.json();

    if (data.status === 1) {
      const p = data.product;
      newFoodName.value = p.product_name || '';
      newFoodProt.value = p.nutriments.proteins_100g || '';
      newFoodCarb.value = p.nutriments.carbohydrates_100g || '';
      newFoodFat.value = p.nutriments.fat_100g || '';
      newFoodKcal.value = p.nutriments['energy-kcal_100g'] || '';

      alert("Dados preenchidos automaticamente!");
    } else {
      alert("Produto n√£o encontrado no banco do Open Food Facts.");
    }
  } catch (err) {
    console.error(err);
    alert("Erro ao escanear: " + err);
 } finally {
  preview.style.display = 'none';

  // Parar todas as tracks da c√¢mera (necess√°rio no iPhone)
  if (preview.srcObject) {
    preview.srcObject.getTracks().forEach(track => track.stop());
    preview.srcObject = null;
  }

  if (codeReader) {
    codeReader.reset();
  }
}
});


</script>

</head>
<body>
<header class="header">
  <div class="brand"><img src="abnutri_logo.png" class="logo" alt="AB Logo"><div><div class="title">AB Nutri</div><div class="small muted" id="userEmail"></div></div></div>
  <nav class="topnav" id="topnav" style="display:none">
    <div class="chip" data-page="registro">Registro</div>
    <div class="chip" data-page="banco">Banco</div>
    <div class="chip" data-page="auditoria">Auditoria</div>
    <div class="chip" data-page="metabolismo">Metabolismo</div>
    <div class="chip" data-page="exportar">Exportar</div>
    <div class="chip" id="logoutBtn" style="margin-left:18px;background:#0b0d0f;border:1px solid #222">Sair</div>
  </nav>
</header>

<!-- Login screen -->
<main id="app">
  <section id="loginScreen" class="center-screen">
    <div class="card login-card">
      <div style="text-align:center;margin-bottom:8px"><img src="abnutri_logo.png" alt="AB Logo" style="width:120px;margin-bottom:8px"><div class="small-muted">Controle di√°rio de calorias ‚Äî fa√ßa login</div></div>
      <input id="email" class="input" placeholder="Email" />
      <input id="password" class="input" placeholder="Senha" type="password" />
      <div style="display:flex;gap:10px;margin-top:8px">
        <button id="loginBtn" class="btn">Entrar</button>
        <button id="registerBtn" class="btn ghost">Cadastrar</button>
      </div>
      <div class="footer-note">Se ainda n√£o tem conta, clique em Cadastrar. </div>
    </div>
    <div class="small-muted">‚ÄúUma forma simples e pr√°tica de cuidar da sua sa√∫de todos os dias.‚Äù</div>
  </section>

  <!-- Main container -->
  <section id="mainScreen" style="display:none">
    <div class="container">
      <!-- Registro page -->
      <div id="page-registro" class="card" style="display:none">
        <div class="flex"><div>
          <div class="section-title">Registro di√°rio</div>
          <div class="small-muted">Selecione a data</div>
          <input id="registroDate" type="date" class="input" style="width:200px"/>
        </div>
        <div class="space"></div>
        <div class="right">
          <div class="badge" id="metaDia">Meta di√°ria: 0 kcal</div>
          <div class="badge" id="consumido">Consumido: 0 kcal</div>
          <div class="badge" id="restante">Restante: 0 kcal</div>
        </div></div>

        <div style="margin-top:14px">
          <div class="meal-buttons" id="mealBtns">
            <button class="chip meal" data-meal="cafedamanha">Caf√© da manh√£</button>
            <button class="chip meal" data-meal="lanchmanha">Lanche manh√£</button>
            <button class="chip meal" data-meal="almoco">Almo√ßo</button>
            <button class="chip meal" data-meal="lanchetarde">Lanche tarde</button>
            <button class="chip meal" data-meal="pretreino">Pr√©-treino</button>
            <button class="chip meal" data-meal="postreino">P√≥s-treino</button>
            <button class="chip meal" data-meal="jantar">Jantar</button>
          </div>

          <div style="margin-top:12px" class="card">
            <div class="section-title">Adicionar alimento</div>
            <div class="flex">
              <input id="searchFood" class="input" placeholder="Digite para filtrar..." style="flex:1"/>
              <select id="foodSelect" class="input" style="width:320px">
                <option value="">-- selecione --</option>
              </select>
              <input id="foodQty" class="input" placeholder="Quantidade (g ou ml)" style="width:160px"/>
            </div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="addToRegistroBtn" class="btn" style="flex:1">Adicionar ao registro</button>
              <button id="exportDayBtn" class="btn ghost">Exportar Dia</button>
              <button id="importDayBtn" class="btn ghost">Importar Dia</button>
            </div>
          </div>

          <div style="margin-top:12px" class="card">
            <div class="section-title">Itens da refei√ß√£o</div>
            <div id="mealItemsContainer" class="table-scroll">
              <table class="table" id="mealItemsTable"><thead><tr><th>Alimento</th><th>Qtd</th><th>Prot (g)</th><th>Carb (g)</th><th>Gord (g)</th><th>Kcal</th><th></th></tr></thead><tbody></tbody></table>
            </div>
            <div style="margin-top:8px" class="flex">
              <div class="space"></div>
              <div><button id="saveDayBtn" class="btn">Salvar</button></div>
            </div>
          </div>

          <div style="margin-top:12px" class="card">
            <div class="section-title">Resumo do dia</div>
            <div class="flex">
              <div class="badge" id="sumProt">Prote√≠na<br><strong>0 g</strong></div>
              <div class="badge" id="sumCarb">Carboidrato<br><strong>0 g</strong></div>
              <div class="badge" id="sumFat">Gordura<br><strong>0 g</strong></div>
              <div class="badge" id="sumKcal">Calorias<br><strong>0 kcal</strong></div>
            </div>
          </div>

        </div>
      </div>

      <!-- Banco page -->
      <div id="page-banco" class="card" style="display:none">
        <div class="flex">
          <div>
            <div class="section-title">Banco de alimentos</div>
            <div class="small-muted">Gerencie seus alimentos (valores por 100 g/ml)</div>
          </div>
          <div class="space"></div>
          <div class="right">
            <button id="openAddFood" class="chip">+ Adicionar alimento</button>
            <button id="exportBank" class="chip">Exportar banco</button>
            <button id="importBank" class="chip">Importar banco</button>
            <button id="clearBank" class="chip">Excluir banco</button>
          </div>
        </div>
        <div style="margin-top:12px" class="table-scroll">
          <table class="table" id="bankTable"><thead><tr><th>Alimento</th><th>Prot/100</th><th>Carb/100</th><th>Fat/100</th><th>Kcal/100</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <!-- Auditoria page -->
      <div id="page-auditoria" class="card" style="display:none">
        <div class="section-title">Auditoria</div>
        <div class="small-muted">Itens possivelmente fora do padr√£o (soma P+C+G muito alta)</div>
        <div style="margin-top:12px" class="table-scroll">
          <table class="table" id="auditTable"><thead><tr><th>Alimento</th><th>Motivo</th><th>Prot/100</th><th>Carb/100</th><th>Fat/100</th><th>Kcal/100</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <!-- Metabolismo page -->
      <!-- Exportar page -->
      <div id="page-exportar" class="card" style="display:none">
        <div class="section-title">Exportar</div>
        <div class="small-muted">Gere um preview em A4 com os dados do metabolismo e o registro do dia, ou baixe em PDF.</div>

        <div style="margin-top:12px;display:flex;gap:12px">
          <button id="btnPreview" class="btn">Gerar Preview</button>
          <button id="btnPDF" class="btn ghost">Gerar PDF</button>
        </div>

        <div id="previewContainer" style="margin-top:20px;background:#fff;color:#000;padding:18px;border-radius:8px;display:none;max-width:800px"></div>
      </div>

    
      <div id="page-metabolismo" class="card" style="display:none">
        <div class="section-title">Metabolismo e Meta</div>
        <div class="grid grid-4" style="margin-bottom:10px">
          <div>
            <label class="small-muted">Nome (opcional)</label>
            <input id="metaNome" class="input"/>
            <label class="small-muted">Altura (cm)</label>
            <input id="metaAltura" class="input" placeholder="173"/>
            <label class="small-muted">Objetivo</label>
            <select id="metaObjetivo" class="input">
              <option value="-800">Perder gordura (-800 kcal)</option>
              <option value="0">Manter peso (0 kcal)</option>
              <option value="1000">Ganho de massa (+1000 kcal)</option>
            </select>
          </div>
          <div>
            <label class="small-muted">Sexo</label>
            <select id="metaSexo" class="input"><option value="M">Masculino</option><option value="F">Feminino</option></select>
            <label class="small-muted">N√≠vel de atividade</label>
            <select id="metaAtividade" class="input">
              <option value="1.2">Sedent√°rio (1.2)</option>
              <option value="1.375">Levemente Ativo (1.375)</option>
              <option value="1.55">Moderadamente Ativo (1.55)</option>
              <option value="1.725">Muito Ativo (1.725)</option>
              <option value="1.9">Extremamente Ativo (1.9)</option>
            </select>
            <label class="small-muted">Esteira (km)</label>
            <input id="metaEsteira" class="input" placeholder="0"/>
          </div>
          <div>
            <label class="small-muted">Idade (anos)</label>
            <input id="metaIdade" class="input" placeholder="30"/>
            <label class="small-muted">Peso (kg)</label>
            <input id="metaPeso" class="input" placeholder="70"/>
            <label class="small-muted">Muscula√ß√£o (h)</label>
            <input id="metaMusculacao" class="input" placeholder="0"/>
          </div>
        
          <div>
            <div class="section-title">Medidas Corporais</div>
            <label class="small-muted">Cintura (cm)</label>
            <input id="metaCintura" class="input" placeholder="80"/>
            <label class="small-muted">Pesco√ßo (cm)</label>
            <input id="metaPescoco" class="input" placeholder="40"/>
            <label class="small-muted">Quadril (cm, apenas mulheres)</label>
            <input id="metaQuadril" class="input" placeholder="90"/>
          </div>
</div>

        <div style="display:flex;gap:10px;align-items:center">
          <button id="calcMeta" class="btn">Calcular</button>
          <button id="aplicarMeta" class="btn ghost">Aplicar como Meta</button>
        </div>

        <div style="margin-top:14px" class="flex">
          <div class="badge" id="tmbBadge">TMB<br><strong>0 kcal</strong></div>
          <div class="badge" id="esteiraBadge">Esteira<br><strong>0 kcal</strong></div>
          <div class="badge" id="muscuBadge">Muscula√ß√£o<br><strong>0 kcal</strong></div>
          <div class="badge" id="tdeeBadge">TDEE<br><strong>0 kcal</strong></div>
          <div class="badge" id="metaBadge">Meta<br><strong>0 kcal</strong></div>
          <div class="badge" id="bfBadge">BF<br><strong>0 %</strong></div>
        </div>

      </div>

    </div>
  </section>
</main>

<!-- Add food modal -->
<div id="foodModal" class="modal"><div class="modal-card">
  <div style="display:flex;align-items:center;justify-content:space-between"><div class="section-title">Adicionar alimento</div><button id="closeFoodModal" class="chip">Fechar</button></div>
  <div style="margin-top:8px">
    
<button id="scanBarcodeBtn" class="chip" style="margin-bottom:8px">üì∑ Escanear c√≥digo</button>
<video id="previewScanner" style="width:100%;max-height:260px;display:none;border-radius:8px;margin-bottom:8px"></video>

    <label class="small-muted">Nome do alimento</label><input id="newFoodName" class="input"/>
    <label class="small-muted">Tipo de base</label>
    <select id="newFoodBase" class="input"><option value="100">por 100 g/ml</option><option value="unit">unidade</option></select>
    <label class="small-muted">Quantidade da base (se n√£o 100)</label><input id="newFoodBaseQty" class="input" placeholder="ex: 200 (ml) ou 85 (g)"/>
    <div style="display:flex;gap:8px">
      <div style="flex:1"><label class="small-muted">Prote√≠na (g)</label><input id="newFoodProt" class="input"/></div>
      <div style="flex:1"><label class="small-muted">Carboidrato (g)</label><input id="newFoodCarb" class="input"/></div>
      <div style="flex:1"><label class="small-muted">Gordura (g)</label><input id="newFoodFat" class="input"/></div>
    </div>
    <label class="small-muted">Kcal (opcional)</label><input id="newFoodKcal" class="input" placeholder="Se vazio calculo 4/4/9"/>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="cancelAddFood" class="chip">Cancelar</button>
      <button id="saveFoodBtn" class="btn">Salvar</button>
    </div>
  </div>
</div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDYcgm0wfWgecIFvjSV3MF2QLdUuuCwoLU",
  authDomain: "abfitness-af1cc.firebaseapp.com",
  projectId: "abfitness-af1cc",
  storageBucket: "abfitness-af1cc.firebasestorage.app",
  messagingSenderId: "392827676437",
  appId: "1:392827676437:web:386a433fffbeef99bdab1c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* UI refs */
const loginScreen = document.getElementById('loginScreen');
const mainScreen = document.getElementById('mainScreen');
const topnav = document.getElementById('topnav');
const userEmail = document.getElementById('userEmail');

const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');
const emailIn = document.getElementById('email');
const passIn = document.getElementById('password');
const logoutBtn = document.getElementById('logoutBtn');

const pageRegistro = document.getElementById('page-registro');
const pageBanco = document.getElementById('page-banco');
const pageAud = document.getElementById('page-auditoria');
const pageMeta = document.getElementById('page-metabolismo');
const pageExportar = document.getElementById('page-exportar');
const btnPreview = document.getElementById('btnPreview');
const btnPDF = document.getElementById('btnPDF');
const previewContainer = document.getElementById('previewContainer');


const registroDate = document.getElementById('registroDate');
const foodSelect = document.getElementById('foodSelect');
const foodQty = document.getElementById('foodQty');
const searchFood = document.getElementById('searchFood');
const addToRegistroBtn = document.getElementById('addToRegistroBtn');
const mealItemsTable = document.querySelector('#mealItemsTable tbody');
const mealBtns = document.querySelectorAll('.meal');

const sumProt = document.getElementById('sumProt');
const sumCarb = document.getElementById('sumCarb');
const sumFat = document.getElementById('sumFat');
const sumKcal = document.getElementById('sumKcal');
const metaDia = document.getElementById('metaDia');
const consumido = document.getElementById('consumido');
const restante = document.getElementById('restante');

const bankTable = document.querySelector('#bankTable tbody');
const auditTable = document.querySelector('#auditTable tbody');

const openAddFood = document.getElementById('openAddFood');
const foodModal = document.getElementById('foodModal');
const closeFoodModal = document.getElementById('closeFoodModal');
const saveFoodBtn = document.getElementById('saveFoodBtn');
const newFoodName = document.getElementById('newFoodName');
const newFoodProt = document.getElementById('newFoodProt');
const newFoodCarb = document.getElementById('newFoodCarb');
const newFoodFat = document.getElementById('newFoodFat');
const newFoodKcal = document.getElementById('newFoodKcal');
const newFoodBase = document.getElementById('newFoodBase');
const newFoodBaseQty = document.getElementById('newFoodBaseQty');

const calcMeta = document.getElementById('calcMeta');
const aplicarMeta = document.getElementById('aplicarMeta');
const tmbBadge = document.getElementById('tmbBadge');
const esteiraBadge = document.getElementById('esteiraBadge');
const muscuBadge = document.getElementById('muscuBadge');
const tdeeBadge = document.getElementById('tdeeBadge');
const metaBadge = document.getElementById('metaBadge');

const metaNome = document.getElementById('metaNome');
const metaAltura = document.getElementById('metaAltura');
const metaSexo = document.getElementById('metaSexo');
const metaAtividade = document.getElementById('metaAtividade');
const metaEsteira = document.getElementById('metaEsteira');
const metaIdade = document.getElementById('metaIdade');
const metaPeso = document.getElementById('metaPeso');
const metaMusculacao = document.getElementById('metaMusculacao');
const metaObjetivo = document.getElementById('metaObjetivo');
const metaCintura = document.getElementById('metaCintura');
const metaPescoco = document.getElementById('metaPescoco');
const metaQuadril = document.getElementById('metaQuadril');
const bfBadge = document.getElementById('bfBadge');

let currentUser = null;
let selectedMeal = 'cafedamanha';
let currentDayData = { meals: {} };
let bankCache = []; // {id, name, prot, carb, fat, kcal}

/* helpers */
const uidPath = (uid) => `users/${uid}`;
const bankCollection = (uid) => collection(db, uidPath(uid), 'bank');
const dayDoc = (uid, dateStr) => doc(db, uidPath(uid), 'days', dateStr);
const metaDoc = (uid) => doc(db, uidPath(uid), 'meta', 'settings');

function dateToYMD(d){ return d.toISOString().slice(0,10); }
function calcKcalFromMacros(p,c,f){ return Math.round((p*4)+(c*4)+(f*9)); }

function showPage(page){
  pageRegistro.style.display = 'none';
  pageBanco.style.display = 'none';
  pageAud.style.display = 'none';
  pageMeta.style.display = 'none';
  if(pageExportar) pageExportar.style.display = 'none';
  document.querySelectorAll('.topnav .chip').forEach(ch=>ch.classList.remove('active'));
  const chip = document.querySelector('.topnav .chip[data-page="'+page+'"]');
  if(chip) chip.classList.add('active');
  if(page==='registro') pageRegistro.style.display='block';
  if(page==='banco') pageBanco.style.display='block';
  if(page==='auditoria') pageAud.style.display='block';
  if(page==='metabolismo') pageMeta.style.display='block';
  if(page==='exportar') pageExportar.style.display='block';
}

/* Auth */
registerBtn.addEventListener('click', async ()=>{
  const email = emailIn.value.trim();
  const pass = passIn.value;
  if(!email || !pass){ alert('Preencha email e senha'); return; }
  try{ await createUserWithEmailAndPassword(auth, email, pass); alert('Conta criada.'); }
  catch(e){ console.error(e); alert(e.message); }
});
loginBtn.addEventListener('click', async ()=>{
  const email = emailIn.value.trim();
  const pass = passIn.value;
  if(!email || !pass){ alert('Preencha email e senha'); return; }
  try{ await signInWithEmailAndPassword(auth, email, pass); }
  catch(e){ console.error(e); alert(e.message); }
});
logoutBtn.addEventListener('click', async ()=>{ await signOut(auth); });

onAuthStateChanged(auth, async (u)=>{
  currentUser = u;
  if(u){
    userEmail.textContent = u.email || u.uid;
    loginScreen.style.display='none';
    mainScreen.style.display='';
    topnav.style.display='';
    showPage('registro');
    registroDate.value = dateToYMD(new Date());
    await loadBank();
    await loadMeta();
    await loadDay(registroDate.value);
  } else {
    currentUser = null;
    loginScreen.style.display='';
    mainScreen.style.display='none';
    topnav.style.display='none';
    userEmail.textContent = '';
  }
});

/* Bank CRUD */
async function loadBank(){
  if(!currentUser) return;
  bankCache = [];
  const snap = await getDocs(collection(db, uidPath(currentUser.uid), 'bank'));
  snap.forEach(docu=>{
    const data = docu.data();
    bankCache.push({ id: docu.id, name: data.name, prot: data.prot||0, carb: data.carb||0, fat: data.fat||0, kcal: data.kcal||calcKcalFromMacros(data.prot||0,data.carb||0,data.fat||0) });
  });
  renderBank();
  populateFoodSelect();
  renderAudit();
}

function renderBank(){
  bankTable.innerHTML = '';
  bankCache
    .slice() // cria c√≥pia
    .sort((a, b) => a.name.localeCompare(b.name, 'pt-BR')) // ordena por nome
    .forEach(item=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${item.name}</td>
        <td>${(item.prot||0).toFixed(2)}</td>
        <td>${(item.carb||0).toFixed(2)}</td>
        <td>${(item.fat||0).toFixed(2)}</td>
        <td>${(item.kcal||0)}</td>
        <td>
          <button class="chip" data-id="${item.id}" data-act="edit">Corrigir</button>
          <button class="chip" data-id="${item.id}" data-act="del">Excluir</button>
        </td>`;
      bankTable.appendChild(tr);
    });
}

function populateFoodSelect(filter=''){
  foodSelect.innerHTML = '<option value="">-- selecione --</option>';
  bankCache
    .slice()
    .filter(i => i.name.toLowerCase().includes(filter.toLowerCase()))
    .sort((a, b) => a.name.localeCompare(b.name, 'pt-BR')) // ordena por nome
    .forEach(item=>{
      const opt = document.createElement('option');
      opt.value = item.id;
      opt.textContent = item.name;
      foodSelect.appendChild(opt);
    });
}

bankTable.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const id = btn.dataset.id;
  const act = btn.dataset.act;
  const item = bankCache.find(b=>b.id===id);
  if(act==='del'){ if(!confirm('Excluir alimento?')) return; await deleteDoc(doc(db, uidPath(currentUser.uid), 'bank', id)); await loadBank(); }
  if(act==='edit'){
    newFoodName.value = item.name;
    newFoodProt.value = item.prot;
    newFoodCarb.value = item.carb;
    newFoodFat.value = item.fat;
    newFoodKcal.value = item.kcal;
    newFoodBase.value = '100';
    newFoodBaseQty.value = '';
    foodModal.classList.add('open');
    saveFoodBtn.onclick = async ()=>{
      await updateDoc(doc(db, uidPath(currentUser.uid), 'bank', id), {
        name: newFoodName.value.trim(),
        prot: parseFloat(newFoodProt.value)||0,
        carb: parseFloat(newFoodCarb.value)||0,
        fat: parseFloat(newFoodFat.value)||0,
        kcal: parseInt(newFoodKcal.value) || calcKcalFromMacros(parseFloat(newFoodProt.value)||0,parseFloat(newFoodCarb.value)||0,parseFloat(newFoodFat.value)||0)
      });
      foodModal.classList.remove('open'); await loadBank();
    };
  }
});

// Listener para corrigir itens suspeitos na Auditoria
auditTable.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const id = btn.dataset.id;
  const act = btn.dataset.act;
  const item = bankCache.find(b=>b.id===id);
  
  if(act === 'audit-corr' && item){
    // Preenche modal com os dados do alimento
    newFoodName.value = item.name;
    newFoodProt.value = item.prot;
    newFoodCarb.value = item.carb;
    newFoodFat.value = item.fat;
    newFoodKcal.value = item.kcal;
    newFoodBase.value = '100';
    newFoodBaseQty.value = '';

    foodModal.classList.add('open');
    
    // Ao salvar, atualiza o item no banco
    saveFoodBtn.onclick = async ()=>{
      await updateDoc(doc(db, uidPath(currentUser.uid), 'bank', id), {
        name: newFoodName.value.trim(),
        prot: parseFloat(newFoodProt.value)||0,
        carb: parseFloat(newFoodCarb.value)||0,
        fat: parseFloat(newFoodFat.value)||0,
        kcal: parseInt(newFoodKcal.value) || calcKcalFromMacros(
          parseFloat(newFoodProt.value)||0,
          parseFloat(newFoodCarb.value)||0,
          parseFloat(newFoodFat.value)||0
        )
      });
      foodModal.classList.remove('open'); 
      await loadBank();
    };
  }
});


openAddFood.addEventListener('click', ()=>{ newFoodName.value=''; newFoodProt.value=''; newFoodCarb.value=''; newFoodFat.value=''; newFoodKcal.value=''; newFoodBaseQty.value=''; foodModal.classList.add('open'); saveFoodBtn.onclick = createFood; });
closeFoodModal.addEventListener('click', ()=>foodModal.classList.remove('open'));

document.getElementById('cancelAddFood').addEventListener('click', ()=>{
  foodModal.classList.remove('open');
});


async function createFood(){
  const name = newFoodName.value.trim();
  if(!name){ alert('Nome obrigat√≥rio'); return; }
  const prot = parseFloat(newFoodProt.value)||0;
  const carb = parseFloat(newFoodCarb.value)||0;
  const fat = parseFloat(newFoodFat.value)||0;
  const kcal = parseInt(newFoodKcal.value) || calcKcalFromMacros(prot,carb,fat);
  await addDoc(collection(db, uidPath(currentUser.uid), 'bank'), { name, prot, carb, fat, kcal });
  foodModal.classList.remove('open'); await loadBank();
}

document.getElementById('exportBank').addEventListener('click', async ()=>{
  if(!currentUser) return alert('Logue-se');
  const data = bankCache;
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='abnutri_bank.json'; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('importBank').addEventListener('click', ()=>{
  const f = document.createElement('input'); f.type='file'; f.accept='.json';
  f.onchange = async ()=>{
    const file = f.files[0]; const txt = await file.text(); try{ const arr=JSON.parse(txt); for(const it of arr){ await addDoc(collection(db, uidPath(currentUser.uid), 'bank'), { name: it.name, prot: it.prot||0, carb: it.carb||0, fat: it.fat||0, kcal: it.kcal||calcKcalFromMacros(it.prot||0,it.carb||0,it.fat||0) }); } await loadBank(); alert('Importado'); }catch(e){alert('Erro ao importar: '+e.message)}
  }; f.click();
});

document.getElementById('clearBank').addEventListener('click', async ()=>{
  if(!confirm('Excluir todo banco?')) return;
  const snap = await getDocs(collection(db, uidPath(currentUser.uid), 'bank'));
  for(const d of snap.docs) await deleteDoc(doc(db, uidPath(currentUser.uid), 'bank', d.id));
  await loadBank();
});

/* Registro */
registroDate.addEventListener('change', async ()=>{ if(!currentUser) return; await loadDay(registroDate.value); });

async function loadDay(dateStr){
  if(!currentUser) return;
  if(!dateStr) dateStr = dateToYMD(new Date());
  const ddoc = await getDoc(dayDoc(currentUser.uid, dateStr));
  if(ddoc.exists()) currentDayData = ddoc.data(); else currentDayData = { meals: {} };
  renderDay();
}

function renderDay(){
  populateFoodSelect(searchFood.value);
  renderMealItems();
  computeDaySummary();
  metaDia.textContent = 'Meta di√°ria: ' + (window.userMeta?.meta||0) + ' kcal';
}

function getMealList(meal){ return currentDayData.meals?.[meal] || []; }

function renderMealItems(){
  mealItemsTable.innerHTML = '';
  const items = getMealList(selectedMeal);
  items.forEach((it, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.name}</td><td>${it.qty}</td><td>${it.prot.toFixed(2)}</td><td>${it.carb.toFixed(2)}</td><td>${it.fat.toFixed(2)}</td><td>${it.kcal}</td><td><button class="chip" data-idx="${idx}" data-act="rem">Remover</button></td>`;
    mealItemsTable.appendChild(tr);
  });
}

mealItemsTable.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const idx = parseInt(btn.dataset.idx);
  const act = btn.dataset.act;
  if(act==='rem'){
    const arr = getMealList(selectedMeal);
    arr.splice(idx,1);
    currentDayData.meals[selectedMeal]=arr;
    renderMealItems(); computeDaySummary();
  }
});

document.querySelectorAll('.meal').forEach(b=>{
  b.addEventListener('click', (ev)=>{
    selectedMeal = ev.target.dataset.meal;
    document.querySelectorAll('.meal').forEach(m=>m.classList.remove('active'));
    ev.target.classList.add('active');
    renderMealItems();
  });
});

addToRegistroBtn.addEventListener('click', async ()=>{
  const foodId = foodSelect.value;
  const qty = parseFloat(foodQty.value);
  if(!foodId || !qty){ alert('Selecione alimento e quantidade'); return; }
  const item = bankCache.find(b=>b.id===foodId);
  if(!item) return alert('Alimento n√£o encontrado');
  const factor = qty/100;
  const entry = { name: item.name, qty, prot: item.prot*factor, carb: item.carb*factor, fat: item.fat*factor, kcal: Math.round(item.kcal*factor) };
  const arr = getMealList(selectedMeal);
  arr.push(entry);
  currentDayData.meals[selectedMeal]=arr;
  renderMealItems(); computeDaySummary();
});

// Filtro de alimentos conforme digita
searchFood.addEventListener('input', () => {
  populateFoodSelect(searchFood.value);

  // Selecionar automaticamente o primeiro item encontrado
  if (foodSelect.options.length > 1) {
    foodSelect.selectedIndex = 1; // pula o "-- selecione --"
  }
});



document.getElementById('saveDayBtn').addEventListener('click', async ()=>{
  if(!currentUser) return;
  const dateStr = registroDate.value || dateToYMD(new Date());
  await setDoc(dayDoc(currentUser.uid,dateStr), currentDayData);
  alert('Dia salvo');
});

function computeDaySummary(){
  let p=0,c=0,f=0,k=0;
  for(const mealName in currentDayData.meals){
    for(const it of currentDayData.meals[mealName]){
      p+=it.prot; c+=it.carb; f+=it.fat; k+=it.kcal;
    }
  }
  sumProt.innerHTML = 'Prote√≠na<br><strong>'+p.toFixed(1)+' g</strong>';
  sumCarb.innerHTML = 'Carboidrato<br><strong>'+c.toFixed(1)+' g</strong>';
  sumFat.innerHTML = 'Gordura<br><strong>'+f.toFixed(1)+' g</strong>';
  sumKcal.innerHTML = 'Calorias<br><strong>'+Math.round(k)+' kcal</strong>';
  consumido.textContent = 'Consumido: ' + Math.round(k) + ' kcal';
  const metaVal = window.userMeta?.meta || 0;
  restante.textContent = 'Restante: ' + Math.round(metaVal - k) + ' kcal';
}

/* Meta logic */
let windowMetaLoaded = false;
let userMeta = null;
window.userMeta = null;

const calcMetaBtn = calcMeta;
calcMetaBtn.addEventListener('click', ()=>{
  const altura = parseFloat(metaAltura.value)||0;
  const peso = parseFloat(metaPeso.value)||0;
  const idade = parseInt(metaIdade.value)||0;
  const sexo = metaSexo.value;
  const fator = parseFloat(metaAtividade.value)||1.2;
  const esteiraKm = parseFloat(metaEsteira.value)||0;
  const muscH = parseFloat(metaMusculacao.value)||0;
  let tmb = 0;
  if(sexo==='M') tmb = (10*peso)+(6.25*altura)-(5*idade)+5;
  else tmb = (10*peso)+(6.25*altura)-(5*idade)-161;
  tmb = Math.round(tmb);
  const esteira = Math.round(peso * esteiraKm);
  const muscu = Math.round(4 * peso * muscH);
  const tdee = Math.round(tmb * fator + esteira + muscu);
  const objetivo = parseInt(metaObjetivo.value)||0;
  const meta = tdee + objetivo;
  tmbBadge.innerHTML = 'TMB<br><strong>'+tmb+' kcal</strong>';
  esteiraBadge.innerHTML = 'Esteira<br><strong>'+esteira+' kcal</strong>';
  muscuBadge.innerHTML = 'Muscula√ß√£o<br><strong>'+muscu+' kcal</strong>';
  tdeeBadge.innerHTML = 'TDEE<br><strong>'+tdee+' kcal</strong>';
  metaBadge.innerHTML = 'Meta<br><strong>'+meta+' kcal</strong>';
  window.userMetaCalc = { tmb, esteira, muscu, tdee, meta };
  // === Calcular BF ===
  let bf = 0;
  const cintura = parseFloat(metaCintura.value)||0;
  const pescoco = parseFloat(metaPescoco.value)||0;
  const quadril = parseFloat(metaQuadril.value)||0;
  if(sexo==='M' && cintura>0 && pescoco>0 && altura>0){
    bf = 495 / (1.0324 - 0.19077 * Math.log10(cintura - pescoco) + 0.15456 * Math.log10(altura)) - 450;
  } else if(sexo==='F' && cintura>0 && pescoco>0 && quadril>0 && altura>0){
    bf = 495 / (1.29579 - 0.35004 * Math.log10(cintura + quadril - pescoco) + 0.22100 * Math.log10(altura)) - 450;
  }
  bf = Math.max(0, Math.round(bf*10)/10);
  bfBadge.innerHTML = 'BF<br><strong>'+bf+' %</strong>';
  window.userMetaCalc.bf = bf;
});

aplicarMeta.addEventListener('click', async ()=>{
  if(!currentUser) return alert('Logue-se');
  if(!window.userMetaCalc) return alert('Calcule antes de aplicar');
  const payload = {
    nome: metaNome.value||'',
    sexo: metaSexo.value,
    idade: parseInt(metaIdade.value)||0,
    peso: parseFloat(metaPeso.value)||0,
    altura: parseFloat(metaAltura.value)||0,
    nivel: parseFloat(metaAtividade.value)||1.2,
    esteira: parseFloat(metaEsteira.value)||0,
    musculacao: parseFloat(metaMusculacao.value)||0,
    objetivo: parseInt(metaObjetivo.value)||0,
    tmb: window.userMetaCalc.tmb,
    tdee: window.userMetaCalc.tdee,
    meta: window.userMetaCalc.meta,
    bf: window.userMetaCalc.bf,
    updatedAt: new Date().toISOString()
  };
  await setDoc(metaDoc(currentUser.uid), payload);
  await loadMeta();
  alert('Meta aplicada e salva');
});

async function loadMeta(){
  if(!currentUser) return;
  const ms = await getDoc(metaDoc(currentUser.uid));
  if(ms.exists()){
    window.userMeta = ms.data();
    metaNome.value = window.userMeta.nome || '';
    metaSexo.value = window.userMeta.sexo || 'M';
    metaAltura.value = window.userMeta.altura || '';
    metaIdade.value = window.userMeta.idade || '';
    metaPeso.value = window.userMeta.peso || '';
    metaAtividade.value = window.userMeta.nivel || '1.2';
    metaEsteira.value = window.userMeta.esteira || 0;
    metaMusculacao.value = window.userMeta.musculacao || 0;
    metaObjetivo.value = window.userMeta.objetivo || '-800';
    tmbBadge.innerHTML = 'TMB<br><strong>'+(window.userMeta.tmb||0)+' kcal</strong>';
    tdeeBadge.innerHTML = 'TDEE<br><strong>'+(window.userMeta.tdee||0)+' kcal</strong>';
    metaBadge.innerHTML = 'Meta<br><strong>'+(window.userMeta.meta||0)+' kcal</strong>';
    window.userMeta = window.userMeta;
    if(window.userMeta.bf){ bfBadge.innerHTML = 'BF<br><strong>'+window.userMeta.bf+' %</strong>'; }
  } else {
    window.userMeta = null;
  }
}

/* Auditoria */
function renderAudit(){
  auditTable.innerHTML = '';
  bankCache.forEach(item=>{
    const sum = (item.prot||0)+(item.carb||0)+(item.fat||0);
    if(sum > 120){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${item.name}</td><td>P+C+G > 120 (suspeito)</td><td>${item.prot}</td><td>${item.carb}</td><td>${item.fat}</td><td>${item.kcal}</td><td><button class="chip" data-id="${item.id}" data-act="audit-corr">Corrigir</button></td>`;
      auditTable.appendChild(tr);
    }
  });
}

/* nav */
document.querySelectorAll('.topnav .chip[data-page]').forEach(ch=>{
  ch.addEventListener('click', (ev)=> showPage(ev.target.dataset.page));
});

showPage('registro');


/* === Export / Preview / PDF handlers === */
const mealNames = {
  cafedamanha: 'Caf√© da manh√£',
  lanchmanha: 'Lanche manh√£',
  almoco: 'Almo√ßo',
  lanchetarde: 'Lanche tarde',
  pretreino: 'Pr√©-treino',
  postreino: 'P√≥s-treino',
  jantar: 'Jantar'
};

if(btnPreview){
  btnPreview.addEventListener('click', ()=>{
    if(!currentUser) return alert('Fa√ßa login para gerar o preview.');
    const meta = window.userMeta || {};
    const day = currentDayData.meals || {};
    // build HTML preview (A4-like)
    let html = `<div style="font-family:Arial,Helvetica,sans-serif">`;
    html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div><h2 style="margin:0">Relat√≥rio Di√°rio</h2><div style="color:#444">Gerado por AB Nutri</div></div><div style="text-align:right"><strong>${meta.nome||''}</strong><div style="font-size:12px;color:#333">${meta.sexo||''} ‚Ä¢ ${meta.idade||''} anos</div></div></div>`;

    // Header metab
    html += `<div style="border:1px solid #222;padding:10px;margin-bottom:12px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
  <div>
    <strong>Dados do Aluno</strong><br/>
    Nome: ${meta.nome||'-'}<br/>
    Idade: ${meta.idade||'-'} anos ‚Ä¢ Sexo: ${meta.sexo||'-'}<br/>
    Altura: ${meta.altura||'-'} cm ‚Ä¢ Peso: ${meta.peso||'-'} kg<br/>
    TMB: ${meta.tmb||0} kcal ‚Ä¢ TDEE: ${meta.tdee||0} kcal ‚Ä¢ BF: ${meta.bf||0}%<br/>
    Objetivo: ${meta.objetivo||'-'}
  </div>
  <img src="abnutri_logo.png" alt="Logo" style="width:80px;height:80px;object-fit:contain;border-radius:8px"/>
</div>`;

    html += `<div><strong>Registro de Refei√ß√µes (${registroDate.value || ''})</strong></div>`;

    let totalP=0, totalC=0, totalF=0, totalK=0;
    for(const mealKey of Object.keys(mealNames)){
      const items = day[mealKey] || [];
      if(items.length===0) continue;
      html += `<div style="margin-top:10px"><div style="font-weight:800;margin-bottom:6px">${mealNames[mealKey]}</div>`;
      html += `<table style="width:100%;border-collapse:collapse;font-size:12px"><thead><tr><th style="border:1px solid #ddd;padding:6px;text-align:left">Alimento</th><th style="border:1px solid #ddd;padding:6px">Qtd</th><th style="border:1px solid #ddd;padding:6px">Prot (g)</th><th style="border:1px solid #ddd;padding:6px">Carb (g)</th><th style="border:1px solid #ddd;padding:6px">Gord (g)</th><th style="border:1px solid #ddd;padding:6px">Kcal</th></tr></thead><tbody>`;
      let mealP=0, mealC=0, mealF=0, mealK=0;
      items.forEach(it=>{
        html += `<tr><td style="border:1px solid #eee;padding:6px">${it.name}</td><td style="border:1px solid #eee;padding:6px">${it.qty}</td><td style="border:1px solid #eee;padding:6px">${it.prot.toFixed(1)}</td><td style="border:1px solid #eee;padding:6px">${it.carb.toFixed(1)}</td><td style="border:1px solid #eee;padding:6px">${it.fat.toFixed(1)}</td><td style="border:1px solid #eee;padding:6px">${it.kcal}</td></tr>`;
        mealP += it.prot; mealC += it.carb; mealF += it.fat; mealK += it.kcal;
      });
      html += `</tbody></table>`;
      html += `<div style="margin-top:6px;font-weight:700">Subtotal: Prot ${mealP.toFixed(1)} g ‚Ä¢ Carb ${mealC.toFixed(1)} g ‚Ä¢ Gord ${mealF.toFixed(1)} g ‚Ä¢ ${mealK} kcal</div>`;
      html += `</div>`;
      totalP += mealP; totalC += mealC; totalF += mealF; totalK += mealK;
    }

    html += `<div style="margin-top:14px;padding:10px;border-top:2px solid #222;font-weight:800">Total do dia: Prot ${totalP.toFixed(1)} g ‚Ä¢ Carb ${totalC.toFixed(1)} g ‚Ä¢ Gord ${totalF.toFixed(1)} g ‚Ä¢ ${totalK} kcal</div>`;

    html += `</div>`;
    previewContainer.innerHTML = html;
    previewContainer.style.display = 'block';
    // scroll to preview
    previewContainer.scrollIntoView({behavior:'smooth'});
  });
}

if(btnPDF){
  btnPDF.addEventListener('click', ()=>{
    if(!previewContainer || !previewContainer.innerHTML.trim()) return alert('Gere o preview primeiro.');
    // ensure html2pdf is available
    if(typeof window.html2pdf === 'undefined'){
      // try to load library dynamically
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
      s.onload = ()=> generatePdfFromElement(previewContainer);
      s.onerror = ()=> alert('N√£o foi poss√≠vel carregar a biblioteca de gera√ß√£o de PDF.');
      document.body.appendChild(s);
    } else {
      generatePdfFromElement(previewContainer);
    }
  });
}

function generatePdfFromElement(element){
  const opt = {
    margin:       10,
    filename:     `relatorio_${(registroDate.value||new Date().toISOString().slice(0,10))}.pdf`,
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2 },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  try{
    window.html2pdf().set(opt).from(element).save();
  }catch(e){ console.error(e); alert('Erro ao gerar PDF: '+e.message); }
}


window._ab = { loadBank, loadDay, calcKcalFromMacros };


</script>
</body>
</html>